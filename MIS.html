<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">    
    <title>IFE ECMAScript</title>
    <style>
        select{
            width: 10%;
            height: 40px;
            font-size: 18px;
        }
        #table-wrapper{
            display: none;
        }
        table{
            width: 800px;
            text-align: right;
        }
        tr:hover{
            background-color: antiquewhite;
        }
        th{
            background-color:white;
            font-size: 90%;
            font-weight: bold;
            border-bottom: 2px solid #111;
            text-align: center;
        }
        th,td{
            padding: 5px 5px 10px 10px;
        }
        
    </style>
</head>
<body>

    <div id="region-radio-wrapper">
        <input type="checkbox" name="region" value="huadong" >华东
        <input type="checkbox" name="region" value="huanan">华南
        <input type="checkbox" name="region" value="huabei">华北
        <button id="region-button">全选</button>
    </div>

    <label> & </label>

    <div id="product-radio-wrapper">
        <input type="checkbox" name="product" value="shouji">手机
        <input type="checkbox" name="product" value="bijiben">笔记本
        <input type="checkbox" name="product" value="zhinengyinxiang">智能音箱
        <button id="product-button">全选</button>
    </div>


    <div id="table-wrapper">
        <table>
            <tr>
                <th>商品</th>
                <th>地区</th>
                <th>1月</th>
                <th>2月</th>
                <th>3月</th>
                <th>4月</th>
                <th>5月</th>
                <th>6月</th>
                <th>7月</th>
                <th>8月</th>
                <th>9月</th>
                <th>10月</th>
                <th>11月</th>
                <th>12月</th>
            </tr>
        </table>
    </div>

    <script>
        let sourceData = [{
    product: "手机",
    region: "华东",
    sale: [120, 100, 140, 160, 180, 185, 190, 210, 230, 245, 255, 270]
}, {
    product: "手机",
    region: "华北",
    sale: [80, 70, 90, 110, 130, 145, 150, 160, 170, 185, 190, 200]
}, {
    product: "手机",
    region: "华南",
    sale: [220, 200, 240, 250, 260, 270, 280, 295, 310, 335, 355, 380]
}, {
    product: "笔记本",
    region: "华东",
    sale: [50, 60, 80, 110, 30, 20, 70, 30, 420, 30, 20, 20]
}, {
    product: "笔记本",
    region: "华北",
    sale: [30, 35, 50, 70, 20, 15, 30, 50, 710, 130, 20, 20]
}, {
    product: "笔记本",
    region: "华南",
    sale: [80, 120, 130, 140, 70, 75, 120, 90, 550, 120, 110, 100]
}, {
    product: "智能音箱",
    region: "华东",
    sale: [10, 30, 4, 5, 6, 5, 4, 5, 6, 5, 5, 25]
}, {
    product: "智能音箱",
    region: "华北",
    sale: [15, 50, 15, 15, 12, 11, 11, 12, 12, 14, 12, 40]
}, {
    product: "智能音箱",
    region: "华南",
    sale: [10, 40, 10, 6, 5, 6, 8, 6, 6, 6, 7, 26]
}]
        var divRegion = document.getElementById("region-radio-wrapper");
        var divProduct = document.getElementById("product-radio-wrapper");
        var table = document.querySelectorAll("#table-wrapper > table");
        var dictProduct = {"手机":0, "笔记本":1, "智能音箱":2}
        ,dictRegion = {"华东":0, "华南":1, "华北":2};

        getCheckBox(divRegion,1);
        getCheckBox(divProduct,2);

        divRegion.onchange = change;
        divProduct.onchange = change;
        
        function getCheckBox(div,num){
            //全选功能
            div.querySelectorAll("button")[0].onclick = function(){
                var val = getChecked(num);
                //console.log(val);
                if(val == 3){
                    div.setAttribute("checkbox-type","all");
                }else{
                    div.setAttribute("checkbox-type","none");
                }

                var boxs = div.querySelectorAll("input");
                if(div.getAttribute("checkbox-type") == "none"){ 
                    for(var i=0; i<boxs.length; i++){
                        boxs[i].checked = true;
                    }
                    div.setAttribute("checkbox-type","all");
                }

                else if(div.getAttribute("checkbox-type") == "all"){
                    for(var i=0; i<boxs.length; i++){
                        boxs[i].checked = false;
                    }
                    div.setAttribute("checkbox-type","none");
                }
                change();
            }
        }

        function getChecked(num){
            //获取checked的inputs
            var boxes = document.querySelectorAll("input");
            var checkedRegion = [0,1,2], checkedProduct = [0,1,2];
            for(var i=0; i<boxes.length;i++){
                if(boxes[i].checked == false && i < 3){
                    checkedRegion.splice(checkedRegion.indexOf(i),1);         //splice()根据引索删除
                    //console.log(checkedRegion);
                }else if(boxes[i].checked == false && i >= 3){
                    checkedProduct.splice(checkedProduct.indexOf(i-3),1);
                }
            }

            if(num == 1){
                return checkedRegion.length;
            }else if(num == 2){
                return checkedProduct.length;
            }else{                
                var checked = {region:checkedRegion, product:checkedProduct};
                return checked;   //js不能return多个数据 -> 处理成对象
            }
            
        }

        function change(){
            removeTable();
            getNewTable();
            format();
        }     
        
        function getData(){
            //获取checked的inputs
            var checkedRegion = getChecked(0).region,
            checkedProduct = getChecked(0).product;
            
            var targetData = [];
            for(var j=0; j<sourceData.length; j++){
                if(checkedRegion.indexOf(dictRegion[sourceData[j].region]) != -1 && 
                checkedProduct.indexOf(dictProduct[sourceData[j].product]) != -1){
                    targetData.push(sourceData[j]);
                }
            }
            
            return targetData;            
        }

        function getNewTable(){
            var regionData = getData();
            for(var i=0; i<regionData.length; i++){
                var newTr = document.createElement("tr");
                newTr.id = "data";
                //product
                var newTd1 = document.createElement("td");
                newTd1.innerHTML = regionData[i].product;
                newTr.appendChild(newTd1);
                //region
                var newTd2 = document.createElement("td");
                newTd2.innerHTML = regionData[i].region;
                newTr.appendChild(newTd2);

                //sale
                var sales = regionData[i].sale
                for(var j=0;j<sales.length; j++){
                    var newTd = document.createElement("td")
                    newTd.innerHTML = sales[j];
                    newTr.appendChild(newTd);
                }
                //row
                table[0].appendChild(newTr);
            }
            
            document.getElementById("table-wrapper").style = "display: block";
        }

        function removeTable(){
            var trs = document.querySelectorAll("tr#data");
            for(var i=0; i<trs.length; i++){
                table[0].removeChild(trs[i]);
            }
        }
    
        function format(){
            var trs = document.querySelectorAll("tr");
            var regionNum = getChecked(1), productNum = getChecked(2);
            
            if(regionNum ==1 && productNum > 1){
                for(var i=0; i<trs.length;i++){                
                    trs[i].insertBefore(trs[i].cells[1], trs[i].cells[0]);  //交换表格两列！
                    if(i%productNum == 1){   //合并
                            trs[i].cells[0].rowSpan = productNum;
                    }else{
                        if(i!=0){
                            trs[i].removeChild(trs[i].cells[0]);
                        }                            
                    }
                }
                
            }else{
                if(trs[0].cells[0].innerHTML == "地区" ){
                    trs[0].insertBefore(trs[0].cells[1], trs[0].cells[0]);  //还原表头
                }
                if(regionNum > 1 && productNum >= 1){
                    for(var j=0; j<trs.length; j++){
                        if(j%regionNum == 1){
                            trs[j].cells[0].rowSpan = regionNum;
                        }else{
                            if(j!=0){
                                trs[j].removeChild(trs[j].cells[0]);
                            }                            
                        }
                    }
                }
            }
        }
    </script>

</body>
</html>